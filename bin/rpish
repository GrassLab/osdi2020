#!/bin/bash

NAME=$0

INTERATIVE=0
POSITIONAL=()

if [ "$#" -eq 0 ];then INTERATIVE=1; fi

while [[ $# -gt 0 ]];do
    key="$1"
    case $key in
        -c)
            POSITIONAL+=("-c")
            POSITIONAL+=("$2")
            shift
            shift
            ;;
        -i)
            INTERATIVE=1
            shift
            ;;
        -h|--help)
            echo -e ""
            echo -e "$NAME [-hi] [--help] [-c command_string | file ...]"
            echo -e ""
            echo -e "    -c [command]  Execute shell command"
            echo -e "    -i            Interact after exec cmd or file"
            echo -e "    -h, --help    Display a usage message on standard output and exit\n"
            exit
            ;;
        *)
            POSITIONAL+=("$1")
            shift
            ;;
    esac
done

set -- "${POSITIONAL[@]}" 

if [ ! -e /dev/ttyUSB0 ];then
    echo "ttyUSB0 not found. Did you connect your device?" >&2
    exit 1
fi

while [[ $# -gt 0 ]];do
    key="$1"
    case $key in
        -c)
            sudo sh -c "echo '$2' | tr -s '\n' '\r' > /dev/ttyUSB0;"
            shift
            shift
            ;;
        *)
            for l in `cat $1`;do
                sudo sh -c "echo $l | tr -s '\n' '\r' > /dev/ttyUSB0;"
                sleep 0.1;
            done
            shift
            ;;
    esac
done

if [[ $INTERATIVE -eq 1 ]]; then
    sudo screen /dev/ttyUSB0 115200
fi
