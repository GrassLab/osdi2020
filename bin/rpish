#!/bin/bash

NAME=$0
DEVICE=/dev/ttyUSB0

INTERATIVE=0
POSITIONAL=()

if [ "$#" -eq 0 ];then INTERATIVE=1; fi

while [[ $# -gt 0 ]];do
    key="$1"
    case $key in
        -c|--command)
            POSITIONAL+=("-c")
            POSITIONAL+=("$2")
            shift
            shift
            ;;
        -d|--device)
            DEVICE=$2
            shift
            shift
            ;;
        -i|--interative)
            INTERATIVE=1
            shift
            ;;
        -img|--image|-k|--kernel)
            POSITIONAL+=("-img")
            POSITIONAL+=("$2")
            shift
            shift
        ;;
        -h|--help)
            echo -e ""
            echo -e "$NAME [-hi] [--help] [-c command_string | file ...]"
            echo -e ""
            echo -e "    -c [command]  Execute shell command"
            echo -e "    -i            Interact after exec cmd or file"
            echo -e "    -h, --help    Display a usage message on standard output and exit\n"
            exit
            ;;
        *)
            POSITIONAL+=("$1")
            shift
            ;;
    esac
done

set -- "${POSITIONAL[@]}" 

if [ ! -e $DEVICE ];then
    echo "$DEVICE not found. Did you connect your device?" >&2
    exit 1
fi

FILEoCMD=0
while [[ $# -gt 0 ]];do
    key="$1"
    case $key in
        -c)
            FILEoCMD=1
            sudo sh -c "echo '$2' | tr -s '\n' '\r' > $DEVICE;"
            shift
            shift
            ;;
        -img)
            FILEoCMD=1
            BYTES=512
            IMG_SIZE=`wc -c kernel8.img | awk '{print $1}'`
            sudo sh -c "echo -ne 'LOADIMG|$IMG_SIZE|' > $DEVICE;"
            sudo sh -c "dd if=$2 bs=$BYTES of=$DEVICE;"
            sudo sh -c "echo -ne '|GMIDAOL' > $DEVICE;"
            shift
            shift
            ;;
        *)
            FILEoCMD=1
            for l in `cat $1`;do
                sudo sh -c "echo $l | tr -s '\n' '\r' > $DEVICE;"
                sleep 0.1;
            done
            shift
            ;;
    esac
done

if [ $INTERATIVE -eq 1 -o $FILEoCMD -eq 0 ]; then
    sudo screen $DEVICE 115200
fi
